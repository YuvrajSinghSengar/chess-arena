<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Chess Arena – Friends</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
<div class="main-container">
    <div class="card">
        <div class="dashboard-header">
            <div>
                <h2>Play with Friends</h2>
                <div id="friendsUser" style="font-size:13px;color:#bbb;"></div>
            </div>
            <button class="secondary-btn" onclick="backDashboard()">Back</button>
        </div>

        <p style="font-size:13px;color:#bbb;margin-bottom:16px;">
            Add friends by username and challenge them to matches.
        </p>

        <div class="form-grid">
            <div class="full-width">
                <label>Add friend by username</label>
                <input id="friendUsername" placeholder="Enter friend's username">
            </div>
        </div>
        <button class="primary-btn" style="margin-top:10px;" onclick="addFriend()">Add Friend</button>

        <h3 style="margin-top:24px;font-size:16px;">Your Friends</h3>
        <table>
            <thead>
            <tr>
                <th>Friend</th>
                <th>Rating</th>
                <th>City</th>
            </tr>
            </thead>
            <tbody id="friendsBody"></tbody>
        </table>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
<script src="firebase-config.js"></script>
<script>
const userIdFriends = localStorage.getItem("userId");
if (!userIdFriends) window.location.href = "auth.html";

let userFriendsData = null;

async function loadFriends() {
    const doc = await db.collection("users").doc(userIdFriends).get();
    userFriendsData = doc.data();
    document.getElementById("friendsUser").innerText =
        `${userFriendsData.fullName} (@${userFriendsData.username}) • Rating: ${userFriendsData.rating || 1000}`;

    const snap = await db.collection("users").doc(userIdFriends)
        .collection("friends").get();

    const tbody = document.getElementById("friendsBody");
    tbody.innerHTML = "";
    for (const d of snap.docs) {
        const fId = d.id;
        const uDoc = await db.collection("users").doc(fId).get();
        if (!uDoc.exists) continue;
        const u = uDoc.data();
        const tr = document.createElement("tr");
        tr.innerHTML = `
            <td>${u.fullName} (@${u.username})</td>
            <td>${u.rating || 1000}</td>
            <td>${u.city || ""}</td>
        `;
        tbody.appendChild(tr);
    }
}

async function addFriend() {
    const uname = document.getElementById("friendUsername").value.trim();
    if (!uname) return alert("Enter a username.");
    if (!userFriendsData) return;

    const snap = await db.collection("users").where("username","==",uname).get();
    if (snap.empty) {
        alert("No user found with that username.");
        return;
    }
    const doc = snap.docs[0];
    if (doc.id === userIdFriends) {
        alert("You cannot add yourself.");
        return;
    }
    await db.collection("users").doc(userIdFriends)
        .collection("friends").doc(doc.id).set({addedAt:new Date()});
    alert("Friend added.");
    document.getElementById("friendUsername").value = "";
    loadFriends();
}

function backDashboard() {
    window.location.href = "dashboard.html";
}

loadFriends();
</script>
</body>
</html>
