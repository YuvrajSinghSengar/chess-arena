<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Chess Arena – Invite Match</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
<div class="main-container">
    <div class="card">
        <div class="dashboard-header">
            <div>
                <h2>Invite Match</h2>
                <div id="inviteUser" style="font-size:13px;color:#bbb;"></div>
            </div>
            <button class="secondary-btn" onclick="backDashboard()">Back</button>
        </div>

        <p style="font-size:13px;color:#bbb;margin-bottom:16px;">
            Send match requests to any player and accept or reject invitations.
        </p>

        <div class="form-grid">
            <div class="full-width">
                <label>Invite by username</label>
                <input id="inviteUsername" placeholder="Enter username to invite">
            </div>
        </div>
        <button class="primary-btn" style="margin-top:10px;" onclick="sendInvite()">Send Invite</button>

        <h3 style="margin-top:24px;font-size:16px;">Incoming Invites</h3>
        <table>
            <thead>
            <tr>
                <th>From</th>
                <th>Rating</th>
                <th>Status</th>
                <th>Action</th>
            </tr>
            </thead>
            <tbody id="incomingBody"></tbody>
        </table>

        <h3 style="margin-top:24px;font-size:16px;">Sent Invites</h3>
        <table>
            <thead>
            <tr>
                <th>To</th>
                <th>Rating</th>
                <th>Status</th>
            </tr>
            </thead>
            <tbody id="sentBody"></tbody>
        </table>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
<script src="firebase-config.js"></script>
<script>
const userId = localStorage.getItem("userId");
if (!userId) window.location.href = "auth.html";

let me = null;

async function loadInvitePage() {
    const doc = await db.collection("users").doc(userId).get();
    if (doc.exists) {
        me = doc.data();
        document.getElementById("inviteUser").innerText =
            ${me.fullName} (@${me.username}) • Rating: ${me.rating || 1000};
    }

    db.collection("invites")
        .where("toId","==",userId)
        .onSnapshot(renderIncoming);

    db.collection("invites")
        .where("fromId","==",userId)
        .onSnapshot(renderSent);
}

function renderIncoming(snap) {
    const tbody = document.getElementById("incomingBody");
    tbody.innerHTML = "";
    snap.forEach(doc => {
        const inv = doc.data();
        const tr = document.createElement("tr");
        tr.innerHTML = `
            <td>${inv.fromName} (@${inv.fromUsername})</td>
            <td>${inv.fromRating || 1000}</td>
            <td>${inv.status}</td>
            <td>
                ${inv.status === "pending"
                    ? "<button class='secondary-btn' onclick=\"respondInvite('"+doc.id+"','accepted')\">Accept</button> " +
                      "<button class='secondary-btn' onclick=\"respondInvite('"+doc.id+"','rejected')\">Reject</button>"
                    : ""
                }
            </td>
        `;
        tbody.appendChild(tr);
    });
}

function renderSent(snap) {
    const tbody = document.getElementById("sentBody");
    tbody.innerHTML = "";
    snap.forEach(doc => {
        const inv = doc.data();
        const tr = document.createElement("tr");
        tr.innerHTML = `
            <td>${inv.toName} (@${inv.toUsername})</td>
            <td>${inv.toRating || 1000}</td>
            <td>${inv.status}</td>
        `;
        tbody.appendChild(tr);
    });
}

async function sendInvite() {
    const uname = document.getElementById("inviteUsername").value.trim();
    if (!uname) return alert("Enter a username.");
    if (!me) return;

    const snap = await db.collection("users").where("username","==",uname).get();
    if (snap.empty) {
        alert("User not found.");
        return;
    }
    const doc = snap.docs[0];
    if (doc.id === userId) {
        alert("You cannot invite yourself.");
        return;
    }
    const u = doc.data();

    await db.collection("invites").add({
        fromId: userId,
        fromUsername: me.username,
        fromName: me.fullName,
        fromRating: me.rating || 1000,
        toId: doc.id,
        toUsername: u.username,
        toName: u.fullName,
        toRating: u.rating || 1000,
        status: "pending",
        createdAt: new Date()
    });

    alert("Invite sent.");
    document.getElementById("inviteUsername").value = "";
}

async function respondInvite(id, status) {
    await db.collection("invites").doc(id).update({status});
}

function backDashboard() {
    window.location.href = "dashboard.html";
}

loadInvitePage();
</script>
</body>
</html>
